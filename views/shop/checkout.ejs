<div class="checkout-page">
  <h2>Thanh toán</h2>
  <% if (items.length === 0) { %>
    <p>Giỏ hàng trống</p>
  <% } else { %>
    <div class="checkout-grid">
      <section class="checkout-form">
        <h3>Thông tin giao hàng</h3>
        <% if (typeof defaultAddress !== 'undefined' && defaultAddress) { %>
          <div class="default-address-block" style="border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:12px">
            <strong>Địa chỉ mặc định của bạn</strong>
            <div style="margin-top:8px">
              <div><%= defaultAddress.recipient %> — <%= defaultAddress.phone %></div>
              <div><%= defaultAddress.street %>, <%= defaultAddress.city %> <%= defaultAddress.postcode ? (' - ' + defaultAddress.postcode) : '' %></div>
            </div>
            <div style="margin-top:10px">
              <form id="use-default-form" method="post" action="/checkout" style="display:inline">
                <input type="hidden" name="recipient" value="<%= defaultAddress.recipient %>" />
                <input type="hidden" name="phone" value="<%= defaultAddress.phone %>" />
                <input type="hidden" name="street" value="<%= defaultAddress.street %>" />
                <input type="hidden" name="city" value="<%= defaultAddress.city %>" />
                <input type="hidden" name="postcode" value="<%= defaultAddress.postcode || '' %>" />
                <button class="btn primary-buy" type="submit">Thanh toán với địa chỉ mặc định</button>
              </form>
              <button id="change-address" class="btn btn-ghost" style="margin-left:8px">Thay đổi địa chỉ</button>
            </div>
          </div>
        <% } %>

        <form method="post" action="/checkout" id="checkout-full-form" style="<%= (defaultAddress ? 'display:none' : '') %>">
          <label>Người nhận
            <input name="recipient" type="text" placeholder="Họ và tên" required />
          </label>
          <label>Số điện thoại
            <input name="phone" type="tel" placeholder="0xxxxxxxxx" pattern="0[0-9]{9}" required />
          </label>
          <label>Địa chỉ
            <input name="street" type="text" placeholder="Số nhà, đường, phường" required />
          </label>
          <label>Thành phố / quận
            <input name="city" type="text" placeholder="Thành phố" required />
          </label>
          <label>Mã bưu chính (tuỳ chọn)
            <input name="postcode" type="text" placeholder="Mã bưu chính" />
          </label>

          <div class="form-actions">
            <button class="btn primary-buy" type="submit">Thanh toán (mô phỏng)</button>
            <button id="qr-pay" type="button" class="btn btn-ghost">Hiển thị mã QR</button>
          </div>
        </form>
      </section>

      <aside class="order-summary">
        <h3>Đơn hàng</h3>
        <div class="summary-list">
          <% items.forEach(it=>{ %>
            <div class="summary-row">
              <div class="summary-left"><%= it.product.title %> x <%= it.quantity %></div>
              <div class="summary-right"><%= (it.product.price * it.quantity).toLocaleString() %> VND</div>
            </div>
          <% }) %>
        </div>
        <div class="summary-total">Tổng: <strong><%= total.toLocaleString() %> VND</strong></div>

        <% if (stripePublishable) { %>
          <button id="stripe-pay" type="button" class="btn btn-ghost">Thanh toán bằng thẻ (Stripe)</button>
        <% } %>
      </aside>
    </div>

    <!-- QR modal (kept simple) -->
    <div id="qr-modal" class="img-modal" aria-hidden="true">
      <div class="img-modal-content" style="background:#fff;padding:16px;border-radius:8px;max-width:360px;text-align:center">
        <h3>Quét QR để thanh toán</h3>
        <div id="qr-target"></div>
        <p id="qr-amount" style="margin-top:8px;font-weight:700"></p>
        <div style="margin-top:8px"><button id="qr-close" class="link-btn">Đóng</button></div>
      </div>
    </div>

    <script src="/js/qrcode.min.js"></script>
    <script>
      document.getElementById('qr-pay').addEventListener('click', ()=>{
        const modal = document.getElementById('qr-modal');
        const amount = '<%= total %>';
        document.getElementById('qr-amount').textContent = (parseInt(amount)||0).toLocaleString() + ' VND';
        renderQRCode(document.getElementById('qr-target'), 'PAY:'+amount);
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
      });
      document.getElementById('qr-close').addEventListener('click', ()=>{ const m=document.getElementById('qr-modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); });
    </script>

    <% if (stripePublishable) { %>
      <script src="https://js.stripe.com/v3/"></script>
      <script>
        const stripe = Stripe('<%= stripePublishable %>');
        function collectAddressValues(){
          // prefer visible inputs; fallback to hidden inputs (use-default form)
          const keys = ['recipient','phone','street','city','postcode'];
          const out = {};
          keys.forEach(k=>{
            const el = document.querySelector('[name="'+k+'"]:not([type="hidden"])') || document.querySelector('#use-default-form [name="'+k+'"]') || document.querySelector('#checkout-full-form [name="'+k+'"]');
            out[k] = el ? el.value : '';
          });
          return out;
        }

        document.getElementById('stripe-pay') && document.getElementById('stripe-pay').addEventListener('click', async ()=>{
          const addr = collectAddressValues();
          const r = await fetch('/create-stripe-session', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(addr) });
          const j = await r.json();
          if (j.id) stripe.redirectToCheckout({ sessionId: j.id });
          else alert('Stripe session error: ' + (j.error || 'unknown'));
        });

        // toggle full form when user clicks change-address
        const changeBtn = document.getElementById('change-address');
        if (changeBtn) {
          changeBtn.addEventListener('click', ()=>{
            const f = document.getElementById('checkout-full-form');
            if (f) f.style.display = f.style.display === 'none' ? '' : 'none';
          });
        }
      </script>
    <% } %>
  <% } %>
</div>
