<div class="checkout-page">
  <h2>Thanh toán</h2>
  <% if (items.length === 0) { %>
    <p>Giỏ hàng trống</p>
  <% } else { %>
    <div class="checkout-grid">
      <section class="checkout-form">
        <h3>Thông tin giao hàng</h3>
        <form method="post" action="/checkout">
          <label>Người nhận
            <input name="recipient" type="text" placeholder="Họ và tên" required />
          </label>
          <label>Số điện thoại
            <input name="phone" type="tel" placeholder="0xxxxxxxxx" pattern="0[0-9]{9}" required />
          </label>
          <label>Địa chỉ
            <input name="street" type="text" placeholder="Số nhà, đường, phường" required />
          </label>
          <label>Thành phố / quận
            <input name="city" type="text" placeholder="Thành phố" required />
          </label>
          <label>Mã bưu chính (tuỳ chọn)
            <input name="postcode" type="text" placeholder="Mã bưu chính" />
          </label>

          <div class="form-actions">
            <button class="btn primary-buy" type="submit">Thanh toán (mô phỏng)</button>
            <button id="qr-pay" type="button" class="btn btn-ghost">Hiển thị mã QR</button>
          </div>
        </form>
      </section>

      <aside class="order-summary">
        <h3>Đơn hàng</h3>
        <div class="summary-list">
          <% items.forEach(it=>{ %>
            <div class="summary-row">
              <div class="summary-left"><%= it.product.title %> x <%= it.quantity %></div>
              <div class="summary-right"><%= (it.product.price * it.quantity).toLocaleString() %> VND</div>
            </div>
          <% }) %>
        </div>
        <div class="summary-total">Tổng: <strong><%= total.toLocaleString() %> VND</strong></div>

        <% if (stripePublishable) { %>
          <button id="stripe-pay" type="button" class="btn btn-ghost">Thanh toán bằng thẻ (Stripe)</button>
        <% } %>
      </aside>
    </div>

    <!-- QR modal (kept simple) -->
    <div id="qr-modal" class="img-modal" aria-hidden="true">
      <div class="img-modal-content" style="background:#fff;padding:16px;border-radius:8px;max-width:360px;text-align:center">
        <h3>Quét QR để thanh toán</h3>
        <div id="qr-target"></div>
        <p id="qr-amount" style="margin-top:8px;font-weight:700"></p>
        <div style="margin-top:8px"><button id="qr-close" class="link-btn">Đóng</button></div>
      </div>
    </div>

    <script src="/js/qrcode.min.js"></script>
    <script>
      document.getElementById('qr-pay').addEventListener('click', ()=>{
        const modal = document.getElementById('qr-modal');
        const amount = '<%= total %>';
        document.getElementById('qr-amount').textContent = (parseInt(amount)||0).toLocaleString() + ' VND';
        renderQRCode(document.getElementById('qr-target'), 'PAY:'+amount);
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
      });
      document.getElementById('qr-close').addEventListener('click', ()=>{ const m=document.getElementById('qr-modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); });
    </script>

    <% if (stripePublishable) { %>
      <script src="https://js.stripe.com/v3/"></script>
      <script>
        const stripe = Stripe('<%= stripePublishable %>');
        document.getElementById('stripe-pay') && document.getElementById('stripe-pay').addEventListener('click', async ()=>{
          const r = await fetch('/create-stripe-session', { method: 'POST', credentials: 'same-origin' });
          const j = await r.json();
          if (j.id) stripe.redirectToCheckout({ sessionId: j.id });
          else alert('Stripe session error: ' + (j.error || 'unknown'));
        });
      </script>
    <% } %>
  <% } %>
</div>
